# AI提示词配置功能

## 🎯 解决的问题

你提到的Redis `keys` 命令问题是一个很好的例子，说明AI需要更专业的提示词来检测生产环境的危险操作。

### 原问题：
```java
connection.async().keys("set");
```

这行代码的问题：
- ❌ **生产环境危险** - Redis keys命令会扫描整个数据库
- ❌ **性能杀手** - 在大数据量时会导致Redis阻塞  
- ❌ **违反最佳实践** - 应该使用SCAN命令替代

## 🔧 新增功能

### 1. AI提示词配置区域
在设置页面新增了"AI分析提示词配置"区域：

```
AI分析提示词配置
┌─────────────────────────────────────────────────────────┐
│ 自定义AI分析提示词 (留空使用默认提示词):                    │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ [大文本框 - 8行高度，支持换行]                        │ │
│ │                                                     │ │
│ │                                                     │ │
│ └─────────────────────────────────────────────────────┘ │
│ [重置为默认提示词] 按钮                                   │
└─────────────────────────────────────────────────────────┘
```

### 2. 专业的默认提示词

#### 🚨 生产环境危险操作检测
- **Redis危险命令**: keys、flushdb、flushall、config等
- **数据库全表扫描**: select * without where、count(*)等  
- **阻塞操作**: 同步IO、长时间循环等
- **资源泄漏**: 未关闭连接、内存泄漏等

#### 🔒 安全问题检测
- SQL注入风险
- XSS攻击风险
- 敏感信息泄露（密码、token等）
- 权限控制缺失
- 输入验证不足

#### 📊 性能问题检测
- N+1查询问题
- 不必要的数据库查询
- 低效的算法实现
- 内存使用不当
- 缓存使用不当

#### 🏗️ 代码质量检测
- 代码重复
- 方法过长或过于复杂
- 命名不规范
- 异常处理不当
- 日志记录不足

#### 🧪 测试覆盖检测
- 缺少单元测试
- 边界条件未测试
- 异常情况未覆盖

## 📋 默认提示词内容

```
请对以下代码变更进行专业的代码评估(Code Review)，重点关注生产环境安全性和最佳实践：

## 🔍 重点检查项目：

### 🚨 生产环境危险操作
- Redis危险命令：keys、flushdb、flushall、config等
- 数据库全表扫描：select * without where、count(*)等
- 阻塞操作：同步IO、长时间循环等
- 资源泄漏：未关闭连接、内存泄漏等

### 🔒 安全问题
- SQL注入风险
- XSS攻击风险  
- 敏感信息泄露（密码、token等）
- 权限控制缺失
- 输入验证不足

### 📊 性能问题
- N+1查询问题
- 不必要的数据库查询
- 低效的算法实现
- 内存使用不当
- 缓存使用不当

### 🏗️ 代码质量
- 代码重复
- 方法过长或过于复杂
- 命名不规范
- 异常处理不当
- 日志记录不足

### 🧪 测试覆盖
- 缺少单元测试
- 边界条件未测试
- 异常情况未覆盖

## 📋 评估要求：
1. 给出0-100的综合评分
2. 标注风险等级：LOW/MEDIUM/HIGH/CRITICAL
3. 列出具体问题和改进建议
4. 特别标注生产环境风险项
```

## 🚀 使用方式

### 1. 使用默认提示词
- 直接启用功能，系统会使用专业的默认提示词
- 默认提示词专门针对生产环境问题进行优化

### 2. 自定义提示词
- 在配置页面的文本框中输入自定义提示词
- 可以根据团队的特定需求调整检查重点
- 支持Markdown格式，让提示词更清晰

### 3. 重置功能
- 点击"重置为默认提示词"按钮
- 恢复到系统优化的默认提示词

## 🎯 针对Redis keys问题的检测

现在AI会专门检测：

### ❌ 危险代码
```java
connection.async().keys("set");        // 会被标记为CRITICAL风险
connection.keys("*");                  // 会被标记为HIGH风险  
jedis.flushAll();                     // 会被标记为CRITICAL风险
```

### ✅ 推荐替代
```java
connection.async().scan();            // 推荐使用SCAN
connection.scan("0", "MATCH", "set*"); // 推荐的模式匹配
```

## 📊 预期检测结果

对于 `connection.async().keys("set");` 代码，AI现在应该能检测出：

```json
{
  "overallScore": 30,
  "riskLevel": "CRITICAL",
  "issues": [
    {
      "filePath": "RedisService.java",
      "lineNumber": 15,
      "severity": "CRITICAL",
      "category": "生产环境危险操作",
      "message": "使用了Redis危险命令keys，在生产环境会导致阻塞",
      "suggestion": "使用SCAN命令替代keys命令，避免阻塞Redis服务"
    }
  ],
  "suggestions": [
    "将keys命令替换为scan命令",
    "添加Redis操作的性能监控",
    "在生产环境禁用危险Redis命令"
  ],
  "summary": "发现严重的生产环境风险：使用了会导致Redis阻塞的keys命令"
}
```

## 🔧 技术实现

### 1. 配置存储
- 在 `CodeReviewSettings` 中添加 `customPrompt` 字段
- 支持持久化存储用户自定义的提示词

### 2. 动态加载
- AI服务会优先使用用户自定义的提示词
- 如果没有自定义，则使用默认的专业提示词

### 3. 界面优化
- 大文本框支持多行编辑
- 支持滚动查看长提示词
- 一键重置功能

现在AI代码评估应该能够准确识别像Redis keys这样的生产环境危险操作了！🎯
