### **技术方案 V3.4：双流智能代码评审引擎**

#### 🎯 **1. 核心愿景与目标**

本插件旨在成为一个**AI驱动的、具备辩证分析能力的“代码评审专家”**。它不仅理解代码的表层逻辑，更能洞察其背后的**业务意图**与潜在的**技术风险**，为开发团队提供深度、专业且自动化的代码评审服务。

核心目标是模拟一个资深架构师的评审过程，对一个完整的Merge Request (MR)或特性分支进行全面分析，并回答：
1.  **功 (Merit)**: 这次变更实现了什么有价值的功能？(意图分析)
2.  **过 (Flaw)**: 这次变更引入了哪些技术风险或坏味道？(影响分析)
3.  **策 (Suggestion)**: 如何在保留其功能价值的同时，修复其技术缺陷？(综合建议)

#### ⚙️ **2. 核心用户工作流**

1.  **触发**: 开发者在IDE中通过右键菜单或工具栏按钮主动触发分析，选择要对比的**源分支** (e.g., `feature/xxx`) 和**目标分支** (e.g., `main`)。
2.  **预处理与加权**: 插件在后台启动**“双流分析引擎”**，对两个分支间的代码差异进行扫描，并从**“意图”**和**“风险”**两个维度，对所有相关的调用链路和代码变更进行加权评分。
3.  **两阶段AI分析**: 
    *   **阶段一 (快速筛选)**: 使用轻量级、高速度的AI模型，根据预处理阶段的权重，筛选出“黄金链路”和“高危链路”。
    *   **阶段二 (深度研判)**: 将筛选出的、带有明确上下文（意图/风险）的关键信息，提交给强大的主分析AI模型，进行深度、辩证的分析。
4.  **报告呈现**: 在IDE的专属工具窗口中，展示一份结构化、层次分明的**“AI代码评审报告”**，清晰地列出对意图、风险的分析以及最终的综合建议。

#### 🏗️ **3. 架构设计 (V3.4 - 双流引擎)**

```
┌───────────────────────────────────────────────────────────────────────────┐
│                            IntelliJ IDEA Plugin                           │
├───────────────────────────────────────────────────────────────────────────┤
│  展现层 (UI Layer)                                                        │
│  ┌──────────────────────────┐   ┌───────────────────────────────────────┐ │
│  │   分支选择对话框         │   │        AI代码评审报告 (Tool Window)     │ │
│  │   - 源/目标分支          │   │        - Part 1: 意图分析             │ │
│  │   - 触发分析按钮         │   │        - Part 2: 风险分析             │ │
│  └──────────────────────────┘   │        - Part 3: 综合评审             │ │
│                                 └───────────────────────────────────────┘ │
├───────────────────────────────────────────────────────────────────────────┤
│  逻辑层 (Core Layer) - 双流智能分析引擎                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                     智能预处理器 (双权重系统)                         │ │
│  │  ┌─────────────────────────────┐  ┌────────────────────────────────┐ │
│  │  │   流A: 意图权重计算器       │  │   流B: 风险权重计算器          │ │
│  │  │   - 黄金链路识别            │  │   - 高危链路识别               │ │
│  │  │   - 业务名词关联            │  │   - 架构违规检测               │ │
│  │  └─────────────────────────────┘  │   - 爆炸半径分析               │ │
│  │                                   └────────────────────────────────┘ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                     两阶段大模型调用管理器                            │ │
│  │  ┌─────────────────────────────┐  ┌────────────────────────────────┐ │
│  │  │   阶段一: 预分析 (小模型)   │  │   阶段二: 深度分析 (大模型)    │ │
│  │  │   - 筛选关键链路            │  │   - 执行辩证Prompt模板         │ │
│  │  └─────────────────────────────┘  └────────────────────────────────┘ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│  ┌──────────────────────────┐   ┌─────────────────┐  ┌─────────────────┐  │
│  │   上下文聚合器           │   │   PSI解析引擎   │  │  嵌入式图引擎   │  │
│  │   - Git Diff/Log         │   │   - AST遍历     │  │   - JGraphT     │  │
│  │   - 测试用例关联         │   └─────────────────┘  │   - 内存图模型  │  │
│  └──────────────────────────┘                      └─────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
```

#### 💾 **4. 关键组件设计深潜**

##### **A. 智能预处理器 (双权重系统)**

此模块是整个系统的“大脑皮层”，负责从原始信息中提炼洞察。它会对`git diff`出的所有变更，并行计算两种权重：

*   **意图权重 (Intent Weight)**: 旨在找到最能代表“开发者想做什么”的1-5条核心路径。
    *   **高权重信号**: 新API端点到数据库的完整链路、与Commit Message核心名词匹配的链路、涉及DTO/VO变更的链路。

*   **风险权重 (Risk Weight)**: 旨在找到最可能“引入问题”的3-5条危险路径。
    *   **高权重信号**: 跨层调用、修改高复用公共方法、涉及事务/异步/安全等敏感注解、缺乏测试覆盖、一次提交修改多个不相关模块。

##### **B. 两阶段大模型调用管理器**

为平衡成本与质量，采取两阶段调用策略：

1.  **阶段一 (预分析)**: 使用**轻量级模型** (e.g., `Gemini Flash`)，输入所有变更和链路，让其根据我们的权重规则，快速筛选出“意图黄金链路”和“风险高危链路”。
2.  **阶段二 (深度分析)**: 使用**强大的主模型**，输入经过第一阶段筛选、提炼、并被明确标记了“意图”或“风险”上下文的高价值信息，然后执行我们精心设计的V3.4版“辩证分析Prompt模板”。

##### **C. 终极Prompt模板 (V3.4)**

这是与大模型沟通的核心。它被设计为一个三段式结构，强制模型进行辩证思考：

1.  **Part 1: 意图分析**: “仅根据‘黄金链路’和相关代码，总结实现了什么功能以及如何实现的。”
2.  **Part 2: 风险分析**: “仅根据‘高危链路’和风险提示，分析潜在的BUG、架构问题和维护性问题。”
3.  **Part 3: 综合评审**: “综合以上两个独立部分的分析，给出一个平衡的、包含具体修改建议的最终评审结论。”

(详细模板见上次对话记录)

#### 🗺️ **5. 实施路线图 (Roadmap)**

1.  **阶段一：基础引擎搭建 (Foundation Engine)**
    *   **任务**: 实现`嵌入式图引擎` (基于JGraphT)，完成对项目代码的全量及增量分析能力。实现`上下文聚合器`，能够稳定地从Git获取分支差异。

2.  **阶段二：双流预处理器 (Dual-Stream Pre-processor)**
    *   **任务**: 开发`智能预处理器`模块。核心是实现“意图权重”和“风险权重”的计算算法。

3.  **阶段三：AI集成与呈现 (AI Integration & Presentation)**
    *   **任务**: 实现`两阶段大模型调用管理器`，并集成V3.4版的Prompt模板。开发用于触发分析和展示报告的UI界面。

4.  **阶段四：高级功能 (Advanced Features)**
    *   **任务**: 集成GitHub/GitLab API，自动获取MR/PR的描述信息。支持在报告中对具体代码行进行评论和建议。提供配置界面，允许用户微调权重计算规则。

---

这份V3.4方案，通过引入“双流分析”和“辩证Prompt”，使插件的分析能力达到了一个新的高度，能够为开发者提供真正有深度、有价值的自动化代码评审。 
