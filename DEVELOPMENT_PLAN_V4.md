# 开发计划 V4.0：双流AI代码评审引擎 (已根据专家建议升级)

基于V4.0技术方案及进一步的专家建议，此开发计划将实施分为五个主要阶段，旨在系统性地构建一个易用、高性能且灵活的AI代码评审插件。

---

### **第一阶段：基础引擎搭建 (Foundational Engine Setup)**
*目标：构建能够解析代码、理解代码结构并聚合变更上下文的核心底层能力，同时兼顾性能与可伸缩性。*

*   **任务 1.1: 集成并配置嵌入式图数据库 (TinkerGraph)**
    *   **1.1.1:** 将 **Apache TinkerPop (TinkerGraph)** 核心库依赖添加到 `build.gradle.kts`。
    *   **1.1.2:** 定义核心图数据模型：`MethodNode`, `ClassNode`, `CallsEdge`, `ImplementsEdge` 的Kotlin数据类，继续。
    *   **1.1.3:** 实现图数据的序列化与反序列化逻辑（如GraphML格式），用于将图模型持久化到磁盘（例如，`.idea/autocr/project.graphml`）。
*   **任务 1.2: 实现PSI解析与代码索引引擎**
    *   **1.2.1:** 开发 `ClassTypeDetector`，实现基于注解和类名的双重策略来识别`BlockType` (CONTROLLER, SERVICE, etc.)。
    *   **1.2.2:** 创建一个 `PsiIndexer` 服务，该服务可以遍历项目源代码，利用PSI API解析代码结构，并将其填充到TinkerGraph实例中。
    *   **1.2.3:** 实现首次全量索引逻辑，扫描整个项目并构建完整的调用关系图。
    *   **1.2.4 (新):** 设计并实现**混合缓存策略**。在加载图时，只将高层模块或文件的“骨架”信息载入内存，在分析具体路径时按需从磁盘加载详细的子图，以优化大型项目的内存占用和启动速度。
*   **任务 1.3: 实现上下文聚合器 (Context Aggregator)**
    *   **1.3.1:** 创建 `GitChangeAnalyzer`，用于执行 `git diff` 命令，精确获取两个分支或多个commit之间的文件变更列表和代码差异(diff)。
    *   **1.3.2:** 创建 `GitLogExtractor`，用于提取指定范围内的所有Commit Messages。
    *   **1.3.3:** 实现 `FullMethodBodyExtractor`，对于有变更的方法，能够利用PSI提取其变更前后的完整方法体。
*   **任务 1.4: 实现知识图谱的可视化预览 (分阶段)**
    *   **1.4.1 (阶段一):** 开发一个导出服务，能够将内存中的图模型实例转换为`.dot`文件格式，并调用本地安装的Graphviz将其渲染为PNG图片，最终在IDE的工具窗口中展示这张**静态图片**。
    *   **1.4.2 (阶段二):** 增强导出功能，支持导出为GraphML格式，方便用户导入到Neo4j, Gephi等专业工具中进行深度分析。

### **第二阶段：双流智能预处理器 (Dual-Stream Pre-processor)**
*目标：开发本方案的核心创新点，实现对代码变更的意图和风险进行自动化加权评分。*

*   **任务 2.1: 开发流A：意图权重计算器 (Intent Weight Calculator)**
    *   **2.1.1:** 使用Gremlin查询语言，实现算法以识别从新API端点出发的完整调用链路。
    *   **2.1.2:** 实现算法，分析链路节点与Commit Message中的业务名词的匹配度。
*   **任务 2.2: 开发流B：风险权重计算器 (Risk Weight Calculator)**
    *   **2.2.1:** 使用Gremlin查询实现架构违规检测逻辑（如 Controller 直连 DAO）。
    *   **2.2.2:** 实现“爆炸半径”分析，通过Gremlin查询节点的入度来识别被大量复用的方法。
*   **任务 2.3: 整合双流预处理器**
    *   **2.3.1:** 创建一个 `SmartPreProcessor` 服务，该服务接收上下文聚合器的输出，并行调用意图和风险计算器。
    *   **2.3.2:** 设计数据结构，用于存储所有变更链路及其对应的意图和风险分数。

### **第三阶段：AI集成与UI呈现 (AI Integration & UI)**
*目标：将后台分析能力与前端用户界面连接起来，调用大模型并向用户展示最终的评审报告。*

*   **任务 3.1: 实现两阶段大模型调用管理器**
    *   **3.1.1:** 实现阶段一（预分析）的调用逻辑。
    *   **3.1.2:** 实现阶段二（深度分析）的调用逻辑，使用V4.0终极Prompt模板。
*   **任务 3.2: 开发用户交互界面 (UI)**
    *   **3.2.1:** 创建一个`Action`，弹出分支/Commit选择对话框。
    *   **3.2.2:** 创建一个专用的Tool Window，用于展示结构化的AI代码评审报告。

### **第四阶段：高级功能与优化 (Advanced Features & Optimization)**
*目标：根据路线图进行功能增强和性能优化，提升插件的成熟度。*

*   **任务 4.1: 性能与准确性优化**
    *   **4.1.1:** 对全量索引和缓存策略进行性能分析和优化。
    *   **4.1.2:** 建立评估基准，持续调优权重计算算法。
*   **任务 4.2: 实现用户可配置项**
    *   **4.2.1:** 在插件设置中增加一个界面，允许用户自定义风险项的权重。
    *   **4.2.2:** 允许用户配置不同阶段使用的大模型API。
*   **任务 4.3 (新): 提供外部数据库连接选项**
    *   **4.3.1:** 在插件设置中，增加连接到外部Neo4j数据库的配置界面（Host, Port, Credentials）。
    *   **4.3.2:** 实现一个数据提供者(DataProvider)的切换逻辑，允许核心分析引擎从默认的嵌入式TinkerGraph切换到外部Neo4j实例。
*   **任务 4.4 (远期): 支持URL模式**
    *   **4.4.1:** 集成GitHub/GitLab的API，实现通过粘贴MR/PR链接直接触发分析的功能。

### **第五阶段：测试、文档与项目管理**
*目标：确保项目质量、可维护性和易用性。*

*   **任务 5.1: 建立测试体系**
    *   **5.1.1:** 为核心算法（如图构建、Gremlin查询）编写单元测试。
    *   **5.1.2:** 为主要用户工作流编写集成测试。
*   **任务 5.2: 完善项目文档**
    *   **5.2.1:** 为核心模块和公共API编写KDoc文档。
    *   **5.2.2:** 更新`README.md`和`USAGE_GUIDE.md`，反映V4.0的新功能和使用方法。